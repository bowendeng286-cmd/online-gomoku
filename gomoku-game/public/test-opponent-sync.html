<!DOCTYPE html>
<html>
<head>
    <title>å¯¹æ‰‹çŠ¶æ€åŒæ­¥æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .status { padding: 5px; margin: 5px 0; }
        .waiting { background-color: #fff3cd; }
        .joined { background-color: #d4edda; }
        button { padding: 8px 15px; margin: 5px; }
    </style>
</head>
<body>
    <h1>å¯¹æ‰‹çŠ¶æ€å®æ—¶åŒæ­¥æµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>æµ‹è¯•æ­¥éª¤:</h3>
        <ol>
            <li>ç‚¹å‡»"åˆ›å»ºæˆ¿é—´"æŒ‰é’®</li>
            <li>è§‚å¯Ÿå¯¹æ‰‹çŠ¶æ€æ˜¾ç¤º"ç­‰å¾…ä¸­..."</li>
            <li>ç‚¹å‡»"æ¨¡æ‹Ÿå¯¹æ‰‹åŠ å…¥"æŒ‰é’®</li>
            <li>è§‚å¯Ÿå¯¹æ‰‹çŠ¶æ€æ›´æ–°ä¸º"å·²åŠ å…¥"</li>
            <li>éªŒè¯è½®è¯¢æ˜¯å¦æŒç»­æ›´æ–°çŠ¶æ€</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>æ§åˆ¶é¢æ¿:</h3>
        <button onclick="createRoom()">åˆ›å»ºæˆ¿é—´</button>
        <button onclick="simulateOpponentJoin()">æ¨¡æ‹Ÿå¯¹æ‰‹åŠ å…¥</button>
        <button onclick="startPolling()">å¼€å§‹è½®è¯¢</button>
        <button onclick="stopPolling()">åœæ­¢è½®è¯¢</button>
        <button onclick="manualCheck()">æ‰‹åŠ¨æ£€æŸ¥çŠ¶æ€</button>
    </div>

    <div class="test-section">
        <h3>æˆ¿é—´ä¿¡æ¯:</h3>
        <div>æˆ¿é—´å·: <span id="roomId">-</span></div>
        <div>ä½ çš„è§’è‰²: <span id="playerRole">-</span></div>
        <div>å¯¹æ‰‹çŠ¶æ€: <span id="opponentStatus" class="status">-</span></div>
        <div>æ¸¸æˆçŠ¶æ€: <span id="gameStatus">-</span></div>
    </div>

    <div class="test-section">
        <h3>è½®è¯¢æ—¥å¿—:</h3>
        <div id="pollingLog" style="height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; font-family: monospace; font-size: 12px;"></div>
    </div>

    <script>
        let currentRoomId = null;
        let pollingInterval = null;
        const API_BASE = '/api/game';

        function log(message) {
            const logDiv = document.getElementById('pollingLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function createRoom() {
            try {
                log('æ­£åœ¨åˆ›å»ºæˆ¿é—´...');
                const response = await fetch(API_BASE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'create_room',
                        customRoomId: 'TEST456',
                        firstPlayer: 'black'
                    })
                });

                const data = await response.json();
                if (data.type === 'room_info') {
                    currentRoomId = data.payload.roomId;
                    document.getElementById('roomId').textContent = data.payload.roomId;
                    document.getElementById('playerRole').textContent = data.payload.playerRole;
                    updateOpponentStatus(data.payload.opponentJoined);
                    document.getElementById('gameStatus').textContent = data.payload.gameState.status;
                    log(`âœ… æˆ¿é—´åˆ›å»ºæˆåŠŸ: ${data.payload.roomId}`);
                } else {
                    log(`âŒ åˆ›å»ºæˆ¿é—´å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                log(`âŒ é”™è¯¯: ${error.message}`);
            }
        }

        async function simulateOpponentJoin() {
            if (!currentRoomId) {
                log('âŒ è¯·å…ˆåˆ›å»ºæˆ¿é—´');
                return;
            }

            try {
                log('æ­£åœ¨æ¨¡æ‹Ÿå¯¹æ‰‹åŠ å…¥...');
                const response = await fetch(API_BASE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'join_room',
                        roomId: currentRoomId
                    })
                });

                const data = await response.json();
                if (data.type === 'room_info') {
                    updateOpponentStatus(data.payload.opponentJoined);
                    document.getElementById('gameStatus').textContent = data.payload.gameState.status;
                    log(`âœ… å¯¹æ‰‹æˆåŠŸåŠ å…¥æˆ¿é—´`);
                } else {
                    log(`âŒ åŠ å…¥æˆ¿é—´å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                log(`âŒ é”™è¯¯: ${error.message}`);
            }
        }

        async function checkRoomStatus() {
            if (!currentRoomId) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}?roomId=${currentRoomId}`);
                const data = await response.json();
                
                if (data.type === 'room_info') {
                    updateOpponentStatus(data.payload.opponentJoined);
                    document.getElementById('gameStatus').textContent = data.payload.gameState.status;
                    log(`ğŸ“¡ è½®è¯¢ç»“æœ: å¯¹æ‰‹çŠ¶æ€ = ${data.payload.opponentJoined ? 'å·²åŠ å…¥' : 'ç­‰å¾…ä¸­'}`);
                } else {
                    log(`âŒ è½®è¯¢å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                log(`âŒ è½®è¯¢é”™è¯¯: ${error.message}`);
            }
        }

        function startPolling() {
            if (!currentRoomId) {
                log('âŒ è¯·å…ˆåˆ›å»ºæˆ¿é—´');
                return;
            }

            if (pollingInterval) {
                log('âš ï¸ è½®è¯¢å·²åœ¨è¿è¡Œä¸­');
                return;
            }

            log('ğŸš€ å¼€å§‹è½®è¯¢æˆ¿é—´çŠ¶æ€...');
            pollingInterval = setInterval(checkRoomStatus, 2000); // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
            checkRoomStatus(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                log('â¹ï¸ è½®è¯¢å·²åœæ­¢');
            } else {
                log('âš ï¸ è½®è¯¢æœªåœ¨è¿è¡Œ');
            }
        }

        function manualCheck() {
            log('ğŸ” æ‰‹åŠ¨æ£€æŸ¥æˆ¿é—´çŠ¶æ€...');
            checkRoomStatus();
        }

        function updateOpponentStatus(opponentJoined) {
            const statusElement = document.getElementById('opponentStatus');
            statusElement.textContent = opponentJoined ? 'å·²åŠ å…¥' : 'ç­‰å¾…ä¸­...';
            statusElement.className = `status ${opponentJoined ? 'joined' : 'waiting'}`;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        log('é¡µé¢å·²åŠ è½½ï¼Œå‡†å¤‡è¿›è¡Œæµ‹è¯•');
    </script>
</body>
</html>